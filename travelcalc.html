
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Carbon Footprint Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #2e8b57;
            --primary-dark: #3cb371;
            --secondary: #2F80ED;
            --danger: #EB5757;
            --warning: #F2994A;
            --light-gray: #F2F2F2;
            --medium-gray: #E0E0E0;
            --dark-gray: #828282;
            --text: #333333;
            --white: #FFFFFF;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #e6f2ed, #c1dacc);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Floating background elements */
        .floating-bg {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            overflow: hidden;
        }
        
        .floating-bg div {
            position: absolute;
            display: block;
            width: 20px;
            height: 20px;
            background: rgba(46, 139, 87, 0.1);
            animation: float 25s linear infinite;
            border-radius: 50%;
            bottom: -20px;
        }
        
        /* Travel-themed elements - float from different sides */
        .floating-bg div:nth-child(1) {
            left: 25%;
            top: -80px;
            width: 80px;
            height: 80px;
            animation: floatFromTop 25s linear infinite;
            animation-delay: 0s;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(46, 139, 87, 0.1)"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>') no-repeat center center;
            background-size: contain;
        }
        
        .floating-bg div:nth-child(2) {
            left: 10%;
            bottom: -20px;
            width: 20px;
            height: 20px;
            animation: floatFromBottom 12s linear infinite;
            animation-delay: 2s;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(46, 139, 87, 0.1)"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>') no-repeat center center;
            background-size: contain;
        }
        
        .floating-bg div:nth-child(3) {
            right: -20px;
            top: 30%;
            width: 20px;
            height: 20px;
            animation: floatFromRight 20s linear infinite;
            animation-delay: 4s;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(46, 139, 87, 0.1)"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>') no-repeat center center;
            background-size: contain;
        }
        
        .floating-bg div:nth-child(4) {
            left: 40%;
            bottom: -60px;
            width: 60px;
            height: 60px;
            animation: floatFromBottom 18s linear infinite;
            animation-delay: 0s;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(46, 139, 87, 0.1)"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>') no-repeat center center;
            background-size: contain;
        }
        
        .floating-bg div:nth-child(5) {
            left: -20px;
            top: 50%;
            width: 20px;
            height: 20px;
            animation: floatFromLeft 15s linear infinite;
            animation-delay: 0s;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(46, 139, 87, 0.1)"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>') no-repeat center center;
            background-size: contain;
        }
        
        .floating-bg div:nth-child(6) {
            right: -110px;
            top: 60%;
            width: 110px;
            height: 110px;
            animation: floatFromRight 22s linear infinite;
            animation-delay: 3s;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(46, 139, 87, 0.1)"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>') no-repeat center center;
            background-size: contain;
        }
        
        .floating-bg div:nth-child(7) {
            left: -150px;
            top: 20%;
            width: 150px;
            height: 150px;
            animation: floatFromLeft 28s linear infinite;
            animation-delay: 7s;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(46, 139, 87, 0.1)"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>') no-repeat center center;
            background-size: contain;
        }
        
        .floating-bg div:nth-child(8) {
            top: -25px;
            left: 50%;
            width: 25px;
            height: 25px;
            animation: floatFromTop 45s linear infinite;
            animation-delay: 15s;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(46, 139, 87, 0.1)"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>') no-repeat center center;
            background-size: contain;
        }
        
        .floating-bg div:nth-child(9) {
            right: -15px;
            bottom: 30%;
            width: 15px;
            height: 15px;
            animation: floatFromRight 35s linear infinite;
            animation-delay: 2s;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(46, 139, 87, 0.1)"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>') no-repeat center center;
            background-size: contain;
        }
        
        .floating-bg div:nth-child(10) {
            left: -150px;
            bottom: 20%;
            width: 150px;
            height: 150px;
            animation: floatFromLeft 11s linear infinite;
            animation-delay: 0s;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(46, 139, 87, 0.1)"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>') no-repeat center center;
            background-size: contain;
        }
        
        /* Animation keyframes for different directions */
        @keyframes floatFromTop {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
                border-radius: 0;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
                border-radius: 50%;
            }
        }
        
        @keyframes floatFromBottom {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
                border-radius: 0;
            }
            100% {
                transform: translateY(-100vh) rotate(720deg);
                opacity: 0;
                border-radius: 50%;
            }
        }
        
        @keyframes floatFromLeft {
            0% {
                transform: translateX(0) rotate(0deg);
                opacity: 1;
                border-radius: 0;
            }
            100% {
                transform: translateX(100vw) rotate(720deg);
                opacity: 0;
                border-radius: 50%;
            }
        }
        
        @keyframes floatFromRight {
            0% {
                transform: translateX(0) rotate(0deg);
                opacity: 1;
                border-radius: 0;
            }
            100% {
                transform: translateX(-100vw) rotate(720deg);
                opacity: 0;
                border-radius: 50%;
            }
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }
        
        .container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }
        
        h1, h2 {
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        h1 {
            font-size: 2.2rem;
            font-weight: 600;
            margin-bottom: 30px;
            position: relative;
            padding-bottom: 10px;
            text-align: center;
        }
        
        h1:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            border-radius: 2px;
        }
        
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .vehicle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
            margin-bottom: 15px;
            background: var(--white);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .vehicle-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        select, input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s ease;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.2);
        }
        
        .transport-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 18px;
        }
        
        .transport-selector select {
            flex: 1;
            margin-bottom: 0;
        }
        
        .add-transport-btn {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .add-transport-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(46, 139, 87, 0.3);
        }
        
        .transport-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
            margin-bottom: 15px;
            background: var(--white);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .transport-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .remove-transport {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .remove-transport:hover {
            background: #c82333;
            transform: scale(1.1);
        }
        
        .results {
            margin-top: 25px;
            padding: 20px;
            background: #e8f5e9;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        
        .action-buttons {
            margin-top: 30px;
            display: flex;
            gap: 15px;
        }
        
        .btn {
            flex: 1;
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(46, 139, 87, 0.3);
        }
        
        .btn:disabled {
            background-color: var(--dark-gray);
            cursor: not-allowed;
            transform: none;
        }
        
        .arrow-button {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            bottom: 20px;
            right: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .arrow-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(46, 139, 87, 0.3);
        }
    </style>
</head>
<body>
    <div class="floating-bg">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
    </div>
    
    <div class="container">
        <h1><i class="fas fa-car"></i> Travel Carbon Footprint Calculator</h1>
        
        <div id="submissionStatus" class="submission-status" style="display: none;">
            <i class="fas fa-check-circle"></i> <span>You've already submitted your travel data today</span>
        </div>
        
        <div class="section" id="privateVehiclesSection">
            <h2><i class="fas fa-car"></i> Your Private Vehicles</h2>
            <div id="vehicleList"></div>
        </div>
        
        <div class="section public-transport-section">
            <h2><i class="fas fa-bus"></i> Public Transportation</h2>
            <div class="transport-selector">
                <select id="publicTransportSelect">
                    <option value="">Select Transport Type</option>
                    <option value="City Bus">City Bus</option>
                    <option value="Electric Bus">Electric Bus</option>
                    <option value="Metro Rail">Metro Rail</option>
                    <option value="Suburban Train">Suburban Train</option>
                    <option value="Auto-Rickshaw (Petrol)">Auto-Rickshaw (Petrol)</option>
                    <option value="Auto-Rickshaw (Electric)">Auto-Rickshaw (Electric)</option>
                    <option value="Taxi (Petrol)">Taxi (Petrol)</option>
                    <option value="Taxi (Diesel)">Taxi (Diesel)</option>
                    <option value="Domestic Flight">Domestic Flight</option>
                </select>
                <button class="add-transport-btn" id="addPublicTransport">
                    <i class="fas fa-plus"></i> Add
                </button>
            </div>
            
            <div id="publicTransportContainer" class="transport-items-container">
                <p class="no-transport-message">No public transport added yet</p>
            </div>
        </div>
        
        <div class="action-buttons">
            <button id="saveButton" class="btn btn-primary">
                <i class="fas fa-save"></i> Save & Calculate
            </button>
            <button id="submitButton" class="btn btn-success">
                <i class="fas fa-paper-plane"></i> Submit Footprint
            </button>
        </div>
        
        <div class="section results" id="results">
            <h2><i class="fas fa-chart-bar"></i> Results</h2>
            <div id="resultsContent"></div>
        </div>
    </div>

    <button class="arrow-button" style="right: auto; left: 20px;" onclick="window.location.href='wastecalc.html'"><i class="fas fa-arrow-left"></i></button>

    <div id="notification"></div>

    <script>
        // Complete JavaScript implementation
        const emissionFactors = {
            // Motorcycles and Scooters
            'Motorcycle <100 CC': 0.0325,
            'Motorcycle <110 CC': 0.0334,
            'Motorcycle <125 CC': 0.0290,
            'Motorcycle <135 CC': 0.0324,
            'Motorcycle <150 CC': 0.0351,
            'Motorcycle <200 CC': 0.0417,
            'Motorcycle <250 CC': 0.0450,
            'Motorcycle <300 CC': 0.0540,
            'Motorcycle <500 CC': 0.0542,
            'Motorcycle 500cc+': 0.0600,
            'Scooter <110 CC': 0.0334,
            'Scooter <125 CC': 0.0351,
            'Scooter <150 CC': 0.0351,
            'Scooter <160 CC': 0.0351,

            // Cars (Hatchbacks)
            'Hatchback <1000 CC': 0.117,
            'Hatchback <1400 CC': 0.130,
            'Premium Hatchback <1600 CC': 0.150,

            // Cars (Sedans)
            'Sedan <1400 CC': 0.142,
            'Sedan <1600 CC': 0.142,
            'Sedan <2000 CC': 0.153,
            'Sedan <2500 CC': 0.161,

            // Cars (SUVs)
            'Compact SUV <1600 CC': 0.153,
            'SUV <2000 CC': 0.193,
            'SUV <3000 CC': 0.197,
            'SUV >3000 CC': 0.197,

            // Cars (MUVs)
            'MUV <2000 CC': 0.213,

            // Public Transport
            'City Bus': 0.033,
            'Electric Bus': 0.033,
            'Metro Rail': 0.033,
            'Suburban Train': 0.033,
            'Auto-Rickshaw (Petrol)': 0.033,
            'Auto-Rickshaw (Electric)': 0.033,
            'Taxi (Petrol)': 0.033,
            'Taxi (Diesel)': 0.033,
            'Domestic Flight': 0.033
        };
        let userId = null;
        let publicTransportList = JSON.parse(localStorage.getItem('publicTransportList')) || [];
        let savedFootprintData = JSON.parse(localStorage.getItem('savedFootprintData')) || {};

        // DOM Elements
        const elements = {
            vehicleList: document.getElementById('vehicleList'),
            publicTransportContainer: document.getElementById('publicTransportContainer'),
            resultsContent: document.getElementById('resultsContent'),
            notification: document.getElementById('notification'),
            submissionStatus: document.getElementById('submissionStatus'),
            saveButton: document.getElementById('saveButton'),
            submitButton: document.getElementById('submitButton')
        };

        // Icon mapping for transport types
        const transportIcons = {
            "City Bus": "bus",
            "Electric Bus": "bus-alt",
            "Metro Rail": "subway",
            "Suburban Train": "train",
            "Auto-Rickshaw (Petrol)": "motorcycle",
            "Auto-Rickshaw (Electric)": "motorcycle",
            "Taxi (Petrol)": "taxi",
            "Taxi (Diesel)": "taxi",
            "Domestic Flight": "plane"
        };

        // Initialize application
        async function init() {
            await fetchUserId();
            await updateVehicleCategories();
            await fetchSelectedVehicles();
            await checkSubmissionStatus();
            displayPublicTransport();
            loadSavedData();
            setupEventListeners();
        }

        // Fetch user ID from server
        function getUserKey(key) {
            return userId ? `${key}_${userId}` : key;
        }
        async function fetchUserId() {
            try {
                const response = await fetch('/get_user_id');
                if (!response.ok) throw new Error('Failed to fetch user ID');
                
                const data = await response.json();
                userId = data.user_id;
            } catch (error) {
                showNotification(error.message, true);
                console.error('Error fetching user ID:', error);
            }
        }

        // Check if user has already submitted today
        async function checkSubmissionStatus() {
            try {
                const response = await fetch('/check_submission_status');
                if (!response.ok) throw new Error('Failed to check submission status');
                
                const data = await response.json();
                if (data.submitted) {
                    disableSubmissionUI();
                    showNotification('You have already submitted today', false);
                }
            } catch (error) {
                console.error('Error checking submission:', error);
            }
        }

        // Disable submission UI
        function disableSubmissionUI() {
            elements.saveButton.disabled = true;
            elements.submitButton.disabled = true;
            elements.submissionStatus.style.display = 'flex';
        }

        // Fetch user's vehicles from server
        async function fetchSelectedVehicles() {
            try {
                const response = await fetch('/get_saved_vehicles');
                if (!response.ok) throw new Error('Failed to fetch vehicles');
                
                const data = await response.json();
                displaySelectedVehicles(data.vehicles);
            } catch (error) {
                showNotification(error.message, true);
                console.error('Error fetching vehicles:', error);
            }
        }

        // Display user's vehicles
        function displaySelectedVehicles(vehicles) {
            elements.vehicleList.innerHTML = '';
            
            if (!vehicles || vehicles.length === 0) {
                elements.vehicleList.innerHTML = '<p class="no-transport-message">No vehicles added yet</p>';
                return;
            }
            
            vehicles.forEach(vehicle => {
                const savedDistance = savedFootprintData[vehicle.vehicle_name]?.distance || 0;
                
                const vehicleRow = document.createElement('div');
                vehicleRow.className = 'vehicle-row';
                vehicleRow.innerHTML = `
                    <div class="vehicle-info">
                        ${vehicle.vehicle_name} <small>(${vehicle.vehicle_category})</small>
                    </div>
                    <div class="vehicle-inputs">
                        <input type="number" min="0" step="1" value="${savedDistance}" 
                               placeholder="Distance (km)" 
                               data-vehicle="${vehicle.vehicle_name}" 
                               data-category="${vehicle.vehicle_category}">
                    </div>
                `;
                elements.vehicleList.appendChild(vehicleRow);
            });
        }

        // Display public transport items
        function displayPublicTransport() {
            elements.publicTransportContainer.innerHTML = '';
            
            if (publicTransportList.length === 0) {
                elements.publicTransportContainer.innerHTML = '<p class="no-transport-message">No public transport added yet</p>';
                return;
            }
            
            publicTransportList.forEach((transport, index) => {
                const item = document.createElement('div');
                item.className = 'transport-item';
                item.innerHTML = `
                    <div class="transport-details">
                        <i class="fas fa-${transportIcons[transport.name] || 'bus'} transport-icon"></i>
                        <span class="transport-name">${transport.name}</span>
                    </div>
                    <div class="transport-inputs">
                        <input type="number" min="0" step="1" value="${transport.distance || 0}" 
                               placeholder="km" data-index="${index}">
                        <button class="remove-transport" data-index="${index}">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                `;
                elements.publicTransportContainer.appendChild(item);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-transport').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    removeTransport(index);
                });
            });
            
            // Add event listeners to distance inputs
            document.querySelectorAll('.transport-item input').forEach(input => {
                input.addEventListener('change', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    updateTransportDistance(index, parseFloat(this.value) || 0);
                });
            });
        }

        // Add new public transport
        function addPublicTransport() {
            const transportSelect = document.getElementById('publicTransportSelect');
            const transportName = transportSelect.value;
            
            if (!transportName) {
                showNotification('Please select a transport type', true);
                return;
            }
            
            if (publicTransportList.some(t => t.name === transportName)) {
                showNotification('This transport is already added', true);
                return;
            }
            
            publicTransportList.push({
                name: transportName,
                distance: 0
            });
            
            localStorage.setItem('publicTransportList', JSON.stringify(publicTransportList));
            displayPublicTransport();
            transportSelect.value = '';
            showNotification(`${transportName} added successfully`, false);
        }

        // Remove transport item
        function removeTransport(index) {
            const removedItem = publicTransportList.splice(index, 1)[0];
            localStorage.setItem('publicTransportList', JSON.stringify(publicTransportList));
            displayPublicTransport();
            showNotification(`Removed ${removedItem.name}`, false);
        }

        // Update transport distance
        function updateTransportDistance(index, distance) {
            publicTransportList[index].distance = distance;
            localStorage.setItem('publicTransportList', JSON.stringify(publicTransportList));
        }

        // Load saved data from localStorage
        function loadSavedData() {
            const savedData = localStorage.getItem('savedFootprintData');
            if (savedData) {
                savedFootprintData = JSON.parse(savedData);
            }
        }

        // Save data to server
        async function saveData() {
            try {
                const dataToSave = collectFormData();
                
                const response = await fetch('/save_travel_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSave)
                });
                
                if (!response.ok) throw new Error(await response.text());
                
                showNotification('Data saved successfully', false);
                displayResults(dataToSave);
                localStorage.setItem('savedFootprintData', JSON.stringify(dataToSave.savedData));
            } catch (error) {
                showNotification(error.message || 'Save failed', true);
                console.error('Save error:', error);
            }
        }

        // Submit data to server
        async function submitData() {
            try {
                elements.submitButton.disabled = true;
                elements.submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                
                const dataToSubmit = collectFormData();
                
                const response = await fetch('/submit_footprint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        travel: dataToSubmit.totalCarbon || 0,
                        energy: parseFloat(localStorage.getItem(getUserKey('energyFootprint'))) || 
                               parseFloat(localStorage.getItem('energyFootprint')) || 0,
                        food: parseFloat(localStorage.getItem(getUserKey('foodFootprint'))) || 
                              parseFloat(localStorage.getItem('foodFootprint')) || 0
                    })
                });
                
                if (!response.ok) throw new Error(await response.text());
                
                showNotification('Submission successful!', false);
                disableSubmissionUI();
                localStorage.removeItem('publicTransportList');
                publicTransportList = [];
                displayPublicTransport();
                
                // Navigate to main.html after successful submission
                setTimeout(() => {
                    window.location.href = 'main.html';
                }, 1500);
            } catch (error) {
                showNotification(error.message || 'Submission failed', true);
                console.error('Submit error:', error);
            } finally {
                elements.submitButton.disabled = false;
                elements.submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Footprint';
            }
        }

        // Collect data from form
        function collectFormData() {
            const savedData = {};
            let totalCarbon = 0;
            
            // Process private vehicles
            document.querySelectorAll('#vehicleList input').forEach(input => {
                const name = input.getAttribute('data-vehicle');
                const category = input.getAttribute('data-category');
                const distance = parseFloat(input.value) || 0;
                
                console.log('Processing vehicle:', name, 'Category:', category, 'Distance:', distance);
                
                // Get emission factor directly from the category
                const emissionFactor = emissionFactors[category];
                console.log('Emission factor:', emissionFactor);
                
                if (emissionFactor === undefined) {
                    console.error('No emission factor found for category:', category);
                }
                
                const emission = distance * (emissionFactor || 0);
                console.log('Calculated emission:', emission);
                
                savedData[name] = { category, distance, emission };
                totalCarbon += emission;
            });
            
            // Process public transport
            publicTransportList.forEach(transport => {
                const emission = transport.distance * (emissionFactors[transport.name] || 0);
                savedData[transport.name] = {
                    category: transport.name,
                    distance: transport.distance,
                    emission
                };
                totalCarbon += emission;
            });
            
            return { savedData, totalCarbon };
        }

        // Display calculation results
        function displayResults(data) {
            elements.resultsContent.innerHTML = '';
            
            if (!data.savedData || Object.keys(data.savedData).length === 0) {
                elements.resultsContent.innerHTML = '<p>No data to display</p>';
                return;
            }
            
            // Add individual items
            for (const [name, details] of Object.entries(data.savedData)) {
                if (details.distance > 0) {
                    const row = document.createElement('div');
                    row.className = 'result-row';
                    row.innerHTML = `
                        <span>${name} (${details.category})</span>
                        <span>${details.distance} km × ${emissionFactors[details.category] || 0} = 
                        <strong>${details.emission.toFixed(2)} kg CO₂</strong></span>
                    `;
                    elements.resultsContent.appendChild(row);
                }
            }
            
            // Add total
            const totalRow = document.createElement('div');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <span>Total Carbon Emissions</span>
                <span><strong>${data.totalCarbon.toFixed(2)} kg CO₂</strong></span>
            `;
            elements.resultsContent.appendChild(totalRow);
        }

        // Show notification
        function showNotification(message, isError) {
            elements.notification.textContent = message;
            elements.notification.className = isError ? 'error' : '';
            elements.notification.style.display = 'block';
            
            setTimeout(() => {
                elements.notification.style.display = 'none';
            }, 3000);
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('addPublicTransport').addEventListener('click', addPublicTransport);
            elements.saveButton.addEventListener('click', saveData);
            elements.submitButton.addEventListener('click', submitData);
        }

        // Add this new function
        async function updateVehicleCategories() {
            try {
                const response = await fetch('/update_vehicle_categories', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to update categories');
                }
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to update categories');
                }
                
                console.log('Categories updated successfully');
                
                // Refresh the vehicle list to show updated categories
                await fetchSelectedVehicles();
            } catch (error) {
                console.error('Error updating categories:', error);
                // Don't show error to user as this is a background operation
            }
        }

        // Call this function when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            init();
        });
    </script>
</body>
</html>
